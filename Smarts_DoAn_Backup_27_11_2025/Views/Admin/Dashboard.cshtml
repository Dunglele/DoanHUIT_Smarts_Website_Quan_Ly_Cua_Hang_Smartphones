@model Smarts_DoAn_Backup_27_11_2025.Models.DashboardList
@using System.Globalization
@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/_AdminPanel.cshtml";

    // Kiểm tra null và khởi tạo list rỗng nếu cần
    // Lưu ý: Phải dùng đúng tên class HOADON, CHITIETHOADON như trong Database Model
    var hoaDons = Model.HoaDons ?? new List<Smarts_DoAn_Backup_27_11_2025.Models.HOADON>();
    var chiTietHoaDons = Model.ChiTietHoaDons ?? new List<Smarts_DoAn_Backup_27_11_2025.Models.CHITIETHOADON>();

    //var sanPhams = Model.SanPhams ?? new List<Smarts_DoAn_Backup_27_11_2025.Models.SANPHAM>();
    var nguoiDungs = Model.NguoiDungs ?? new List<Smarts_DoAn_Backup_27_11_2025.Models.NGUOIDUNG>();

    // Tính toán
    int tongDonHang = hoaDons.Count();

    decimal tongDoanhThu = chiTietHoaDons.Sum(item => item.THANHTIEN ?? 0);

    int tongSanPham = 0;
    foreach(var it in Model.SanPhams)
    {
        if(it.SOLUONG.HasValue)
        {
            // Thêm .Value ở đây để lấy giá trị int bên trong int?
            tongSanPham += it.SOLUONG.Value;
        }
    }

    //int tongSanPham = sanPhams.Count();

    // Kiểm tra tên trường VAITRO
    int tongNguoiDung = nguoiDungs.Count(u => u.VAITRO == "Client");

    var cultureInfo = new CultureInfo("vi-VN");
}

<div class="main-content">
    <header class="admin-header">
        <h4 class="mb-0 fw-bold text-dark">Thống kê tổng quan</h4>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0">
                <h6 class="text-muted">Đơn hàng</h6>
                <h3 class="fw-bold text-primary">@tongDonHang.ToString("N0")</h3>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0">
                <h6 class="text-muted">Doanh thu</h6>
                <h3 class="fw-bold text-success">
                    @tongDoanhThu.ToString("C0", cultureInfo)
                </h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0">
                <h6 class="text-muted">Sản phẩm</h6>
                <h3 class="fw-bold text-warning">@tongSanPham.ToString("N0")</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm border-0">
                <h6 class="text-muted">Khách hàng</h6>
                <h3 class="fw-bold text-info">@tongNguoiDung.ToString("N0")</h3>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm border-0">
                <h5 class="card-title">Doanh thu tháng (Thử nghiệm)</h5>
                <div style="height:300px; position: relative;">
                    <canvas id="monthChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm border-0">
                <h5 class="card-title">Doanh thu năm (Thử nghiệm)</h5>
                <div style="height:300px; position: relative;">
                    <canvas id="yearChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/chart.js"></script>
<script>
    // Hàm khởi tạo biểu đồ để code gọn hơn
    function renderChart(id, type, labels, labelName, data, colors) {
        const ctx = document.getElementById(id);
        if (!ctx) return;

        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: labelName,
                    data: data,
                    backgroundColor: type === 'bar' ? colors : 'rgba(13, 110, 253, 0.1)',
                    borderColor: colors,
                    borderWidth: 2,
                    tension: 0.4, // Tạo đường cong mềm mại cho line chart
                    fill: type === 'line'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false } // Ẩn chú thích nếu chỉ có 1 dòng dữ liệu
                }
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Biểu đồ tháng (Line)
        renderChart('monthChart', 'line',
            ['T1', 'T2', 'T3', 'T4'],
            'Doanh thu',
            [12000, 19000, 3000, 5000],
            '#0d6efd'
        );

        // Biểu đồ năm (Bar)
        renderChart('yearChart', 'bar',
            ['2023', '2024', '2025'],
            'Doanh thu',
            [180000, 220000, 340000],
            '#198754'
        );
    });
</script>
